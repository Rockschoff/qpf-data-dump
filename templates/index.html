<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QPF Data Dump</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.9.3/css/bulma.min.css" />
    <style>
        body {
            padding: 20px;
        }
        #fileName {
            white-space: pre-line; /* Allows new lines for file names */
        }
    </style>
</head>
<body>
    <section class="section">
        <div class="container">
            <h1 class="title">QPF Data Dump</h1>
            
            <!-- File upload form -->
            <div class="box">
                <h2 class="subtitle">Upload Files</h2>
                <form id="uploadForm">
                    <div class="file has-name is-boxed">
                        <label class="file-label">
                            <input class="file-input" type="file" id="fileInput" name="files" multiple>
                            <span class="file-cta">
                                <span class="file-icon">
                                    <i class="fas fa-upload"></i>
                                </span>
                                <span class="file-label">
                                    Click here to choose files
                                </span>
                            </span>
                            <span class="file-name" id="fileName">No files uploaded</span>
                        </label>
                    </div>
                    <button class="button is-primary mt-3" type="submit" id="uploadButton">Upload</button>
                    <p id="uploadStatus" class="mt-3"></p> <!-- Display status here -->
                </form>
            </div>

            <!-- File listing -->
            <div class="box">
                <h2 class="subtitle">Files</h2>
                <ul id="fileList"></ul>
            </div>
        </div>
    </section>

    <script>
        const fileInput = document.getElementById('fileInput');
        const fileName = document.getElementById('fileName');
        const uploadButton = document.getElementById('uploadButton');
        const uploadStatus = document.getElementById('uploadStatus');
        const fileList = document.getElementById('fileList');

        let existingFiles = [];

        // Update file name on selection (for multiple files)
        fileInput.addEventListener('change', () => {
            const files = Array.from(fileInput.files);
            if (files.length > 0) {
                // Display each file name on a new line
                fileName.textContent = files.map(file => file.name).join('\n');
            }
        });

        // Load existing files and store them in `existingFiles` array
        function loadFiles() {
            fetch('/files')
                .then(response => response.json())
                .then(files => {
                    existingFiles = files;  // Store existing files in the array
                    fileList.innerHTML = '';
                    files.forEach(file => {
                        const li = document.createElement('li');
                        li.innerHTML = `${file} <button class="button is-danger is-small" onclick="deleteFile('${file}')">Delete</button>`;
                        fileList.appendChild(li);
                    });
                });
        }

        // Upload multiple files
        document.getElementById('uploadForm').addEventListener('submit', function (e) {
            e.preventDefault();
            const files = Array.from(fileInput.files);
            const formData = new FormData();

            // Check for duplicate file names
            const duplicateFiles = files.filter(file => existingFiles.includes(file.name));

            if (duplicateFiles.length > 0) {
                alert(`File(s) with the following name(s) already exist: ${duplicateFiles.map(file => file.name).join(', ')}. Please rename or remove them before uploading.`);
                return; // Prevent upload if duplicates found
            }

            if (files.length > 0) {
                // Append all selected files to FormData
                files.forEach(file => {
                    formData.append('files', file);
                });

                // Disable upload button and show "Uploading..." message
                uploadButton.disabled = true;
                uploadStatus.textContent = "Uploading...Please do not Refresh";

                fetch('/upload', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    alert(data.message);
                    // Re-enable the upload button and clear the status message
                    uploadButton.disabled = false;
                    uploadStatus.textContent = "";
                    fileName.textContent = "No files uploaded"; // Clear the file names after upload
                    loadFiles();
                })
                .catch(err => {
                    // Re-enable the upload button and show error
                    uploadButton.disabled = false;
                    uploadStatus.textContent = "Upload failed. Try again.";
                    console.error(err);
                });
            } else {
                alert("No files selected.");
            }
        });

        // Delete file
        function deleteFile(filename) {
            fetch(`/delete/${filename}`, { method: 'DELETE' })
                .then(response => response.json())
                .then(data => {
                    alert(data.message);
                    loadFiles();
                });
        }

        // Load files on page load
        loadFiles();
    </script>
</body>
</html>
